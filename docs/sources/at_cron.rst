==================
 at和cron学习笔记
==================

.. contents::

at
==

安装和启动
----------

::

  emerge sys-process/at

  /etc/init.d/atd start
  rc-update add atd

配置文件
--------

- /etc/at/at.allow
- /etc/at/at.deny

1. root用户不受上述文件的权限限制
2. 如果at.allow存在，只有里面列出的用户可以使用at系列的命令，忽略at.deny
3. 如果at.allow不存在，at.deny中没列出的用户可以使用at系列的命令

常用选项
--------

::

  at [-V] [-q queue] [-f file] [-mMlv] timespec...
  at [-V] [-q queue] [-f file] [-mMkv] [-t time]
  at -c job [job...]
  atq [-V] [-q queue]
  at [-rd] job [job...]
  atrm [-V] job [job...]
  batch
  at -b


- -l 即[list]，列出任务，相当于atq

- -d 即[delete]，删除任务，相当于atrm

- -b 即[batch]，在系统空闲时执行任务

- -m 即[mail]，任务完成后用邮件通知
- -M 可以理解为[Never Mail]，不发送邮件进行通知

- -c 将指定的任务需要执行的命令打印到标准输出

如果想要在系统空闲时执行命令，需要输入batch命令，然后输入命令或者脚本。
(使用at -b不起作用)

如果同时使用at -b又指定时间，则如果在指定的时间，系统正忙的话，则暂缓执
行，即在随后的时间内系统不忙的时候执行。

batch命令不接受任何选项，包括时间，是一个交互命令。

时间格式
--------

- at 23:12 2013-3-17    # 2013年3月17日23点12分执行
- at now + 5 minutes    # 5分钟后执行
- at now + 5 days       # 5天后执行
- at 2013-3-17          # 2013年3月17日的此时执行


cron
====

安装和启动
----------

::

  emerge sys-process/vixie-cron

  /etc/init.d/vixie-cron start
  rc-update add vixie-cron

先搜索 /var/spool/cron/crontabs ，这里会以用户名为文件名分别列出各用户
的crontab文件，不要直接编辑，而应用 crontab 命令编辑。

配置文件
--------

- /etc/crontab

这是系统级的配置文件，存放系统周期性地执行的命令。

用户级的配置文件存放于/var/spool/cron/目录下。cron会每分钟检查并取出其
中的指令。

- /etc/cron.allow
- /etc/cron.deny

关于cron.allow和cron.deny的权限设置同at的一样。

常用选项
--------

crontab [-u username] file

crontab [-u username] {-e | -l | -r}

如果后面跟着一个文件的话，会把这个文件提交给cron来周期性地执行。除了不需要指明用户名那一列之外，这个文件的格式与crontab的文件格式相同。

- -u 指定用户，而不是当前用户。

- -l 列出当前用户的cron命令。

- -e 编辑当前用户的cron命令，用 $EDITOR 指定的编辑器。可以用这个命令来修改或者添加新的项。

- -r 删除当前用户的所有cron命令。

时间和日期格式
--------------

格式为

::

  分钟 小时 日期 月份 星期

- 分钟的范围是0-59，0表示整点。
- 小时的范围是0-23，0表示零点。
- 日期的范围是1-31，如果指定了月份，则日期必须是该月的合法日期。
- 月份的范围是1-12。
- 星期用0-7表示，0和7都表示星期天。

其中可以使用特殊表示：

- 星号'*'表示任意时间。
- 逗号','表示并列的时间。
- 短线'-'表示范围。
- 斜线'/'表示周期，例如分钟字段0-59/2表示每2分钟，月份字段*/3表示每隔3个月。

例子

- 17 * * * *         # 每小时第17分钟
- 25 6 * * *         # 每天的6:25
- 47 6 * * 0         # 每周日的6:47
- 52 6 1 * *         # 每个月1号的6:52

疑难问题
--------

安装并启动cron后，第一次运行时出现错误

::

  $ crontab -e
  cannot chdir(/var/spool/cron), bailing out.

看一下权限：

::

  # ls /var/spool/ -l | grep cron
  drwxr-x--- 4 root cron 4096 Oct 17 09:48 cron

这是gentoo出于安全考虑而设置的默认值，如果允许某个用户使用crontab，则需要将其加入cron这个组中：

::

  # gpasswd -a <username> cron


BTW:google了一下，有人说是由于/var/spool/cron文件夹的权限造成的。

::

  # chmod o+rx /var/spool/cron

并且像这样修改权限，这实际上是不安全的，这样的话任何人都可以使用crontab了。

anacron
=======

anacron的是一个协助cron来工作的程序，对于非24小时连续运行的系统来说，有
很多cron工作在系统关机时会得不到执行，anacron的作用就是执行这些被错过的
cron例程的。

安装和启动
----------

::

  emerge sys-process/anacron
  /etc/init.d/anacron start
  rc-update add anacron


参考资料
========

- `Gentoo Linux Cron Guide <http://www.gentoo.org/doc/en/cron-guide.xml>`_

- `红帽企业 Linux 3: 系统管理指南 <http://oss.org.cn/ossdocs/gnu_linux/redhat/rhel-sag-zh_cn-3/ch-autotasks.html>`_
