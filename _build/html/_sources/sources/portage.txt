========================================
 portage 软件包管理系统学习笔记
========================================

.. contents::

根据emerge和equery手册以及gentoo官方文档整理出的一份笔记。

软件包管理
==========

安装软件
-------------

- 安装软件包 ::

	emerge foo

- 假装安装软件包(--pretend)::

	emerge -p foo

- 只下载不安装软件包(--fetchonly) ::

	emerge -f foo

- 查看USE标记(--verbose) ::

	emerge -pv foo

卸载软件
-------------

- 卸载软件包(--unmarge) ::

	emerge -C foo

- 卸载不被依赖的软件包(--depclean) ::

	emerge -c

- 卸载孤立依赖的软件包

	1. 用emerge -DNauv更新整个系统

	#. 用emerge -c移除孤立的软件包

	#. 用revdep-rebuild重建依赖关系

更新系统
-------------

更新portage树 ::

	emerge --sync

更新整个系统 ::

	emerge -DNuva world

-D --deep代表升级world中的软件包及其依赖的所有软件包

-N --newuse代表用新的USE，在修改了USE的设置后使用

-u代表--update

-v代表--verbose

-a代表--ask

验证软件包的完整性
----------------------------

检查软件包foo的完整性(其中的k代表check) ::

	equery k foo

软件包的依赖关系
-------------------------

直接依赖于foo的所有软件包(其中的d代表depends) ::

	equery d foo

直接或间接依赖于foo的软件包(g代表depgraph) ::

	equery g foo

查询软件包(普通查询)
------------------------------

根据名称查询软件包(--search) ::

	emerge -s foo

正则表达式查询(前面加%) ::

	emerge -s '%^emacs'

将软件所属类别名称也归入查询范围，需要加个'%@'。 emerge -s '%@app.*emacs$'会查询以app开 头以emacs结尾的软件包，例如app-editors/emacs。

在软件包描述中查询软件(--searchdesc) ::

	emerge -S foo

查询已安装的某个文件属于哪个包(belong) ::

	equery b /bin/cat

查询某个包所安装的文件及其位置(file) ::

	equery f foo

查询软件包(高级查询)
------------------------------

利用 equery list [options] PKG 这种命令格式，使用一些额外的 选项来执行软件包的高级查询。

注意在不使用-f选项时需要全部匹配，例如equery list 'emacs'只 会匹配名称
为emacs的软件包，而不是名称包括emacs的所有软件包。而如 果使用了-f选项则
不需要全部匹配，例如下例中即不需要用equery list -f 'emacs'则会匹配名称
包含emacs的所有软件包。

常用选项

-d, --duplicates
List only packages with more than one version installed.

-f, --full-regex
The supplied query is a regular expression.

-m, --mask-reason
Print the reason why a package was masked.

-I, --exclude-installed
Exclude installed packages from being output.

-o, --overlay-tree
Include package from overlays in the search path.

-p, --portage-tree
Include all packages from the Portage tree in the search path. Use this option to search through all standard Gentoo packages, including those that are not installed.

查询系统中安装的所有软件包 ::

	~# equery l '*'

查询系统中安装的两个及以上不同版本的软件包(duplicates) ::

	~# equery l -d '*'

查询名称为'emacs'的软件包 ::

	~# equery l 'emacs'
	* Searching for emacs ...
	[IP-] [	 ] app-editors/emacs-23.3-r1:23


查询名称中包含'emacs'的软件包(这里的"名称"不包括软件包 所属的类别名称) ::

	~# equery l '*emacs*'
	 * Searching for *emacs* ...
	[IP-] [	 ] app-admin/eselect-emacs-1.13:0
	[IP-] [	 ] app-editors/emacs-23.3-r1:23
	[IP-] [	 ] app-emacs/emacs-common-gentoo-1.2-r2:0
	[IP-] [	 ] app-emacs/emacs-w3m-1.4.437_pre20110310:0
	[IP-] [	 ] virtual/emacs-23:0

用正则表达式查询(也在软件包所属的类别名称里搜索) ::

	~# equery l -f 'emacs'
	 * Searching for emacs ...
	[IP-] [	 ] app-admin/eselect-emacs-1.13:0
	[IP-] [	 ] app-editors/emacs-23.3-r1:23
	[IP-] [	 ] app-emacs/autoconf-mode-2.68:0
	[IP-] [	 ] app-emacs/color-theme-6.6.0-r1:0
	[IP-] [	 ] app-emacs/dropdown-list-20090814-r1:0
	[IP-] [	 ] app-emacs/emacs-common-gentoo-1.2-r2:0
	[IP-] [	 ] app-emacs/emacs-w3m-1.4.437_pre20110310:0
	[IP-] [	 ] app-emacs/po-mode-0.18.1.1:0
	[IP-] [	 ] app-emacs/sawfish-1.32:0
	[IP-] [	 ] app-emacs/yasnippet-0.6.1c:0
	[IP-] [	 ] virtual/emacs-23:0
	~# equery l -f 'app-admin'
	 * Searching for app-admin ...
	[IP-] [	 ] app-admin/eselect-1.2.15:0
	[IP-] [	 ] app-admin/eselect-ctags-1.13:0
	[IP-] [	 ] app-admin/eselect-emacs-1.13:0
	[IP-] [	 ] app-admin/eselect-fontconfig-1.0:0
	[IP-] [	 ] app-admin/eselect-mesa-0.0.10:0
	[IP-] [	 ] app-admin/eselect-opengl-1.2.1:0
	[IP-] [	 ] app-admin/eselect-python-20100321:0
	[IP-] [	 ] app-admin/perl-cleaner-2.7:0
	[IP-] [	 ] app-admin/python-updater-0.9:0

在整个portage树里搜索(-p)，包括没有安装的软件包

看看有那些管理工具 ::

	~# equery l -fp 'app-admin'

同上，不包括没有安装的软件包(-I)
看看有那些管理工具没有安装 ::

	~# equery l -fIp 'app-admin'

存放目录
=============

- portage树存放目录 /usr/portage

- 已下载软件包的存放目录 /usr/portage/distfiles

- 明确安装的软件清单 /var/lib/portage/world

USE设置
=======

USE文件的存放目录
-----------------

- 全局USE列表 /usr/portage/profiles/use.desc

- 局部USE列表 /usr/portage/profiles/use.local.desc

局部USE列表文件中包含了很长的软件包名单，以及每个软件包 特定的USE标记

USE使用优先级(从低到高)

1. make.defaults中的USE设定

#. /etc/make.conf中的USE设定

#. /etc/protage/package.use中的USE设定

#. USE环境变量

查看和操作USE标记
-----------------

查看全局USE的最终设定值 ::

	emerge --info

查看emacs软件包使用的USE值 ::

	equery uses emacs

使用euse查看USE标记，euse是一个专门查看和设置USE的工具。

查看当前激活的USE标记 ::

	euse -a

查看当前激活的全局USE标记 ::

	euse -a -g

查看当前激活的局部USE标记 ::

	euse -a -l
